<!DOCTYPE html>
<html th:lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="shortcut icon" type="x-icon" href="icons/quizlogo99.svg">
    <link rel="stylesheet" href="styles/general.css">
    <link rel="stylesheet" href="styles/header.css">
    <link rel="stylesheet" href="styles/profile.css">
    <link rel="stylesheet" href="styles/card_collection.css">
    <title>Card Collection</title>
</head>
<body th:data-user-id="${#authentication.principal.id}">
    <div class="background-image"></div>
    <div class="header">
        <div class="logo-box">
            <a th:href="@{${'/home'}}">
                <img class="logo" src="icons/quizlogo99.svg" alt="Logo">
            </a>
            <div class="logo-name">
                <span class="quiz">QUIZ</span>
                <span class="game">GAME</span>
            </div>
        </div>
        <div class="profile-box">
            <span class="pf-lvl">Lvl - 01</span>
            <div >
                <img class="profile" id="profile" src="images/space man.jpg" alt="Logo">
            </div>
        </div>
    </div>
    <div class="profile-container" id="profile-container">
        <div class="top-box">
            <div class="top-lf">Profile</div>
            <div class="top-rg">
                <img class="speaker-icon" src="icons/speaker.png" alt="Seapker icon">
                <a href="/update_profile.html">
                    <img class="edit-icon" src="icons/lucide_edit.png" alt="Edit icon">
                </a>
            </div>
        </div>
        <div class="bottom-box">
            <div class="pf-picture"><img src="images/space man.jpg" alt="Profile"></div>
            <div class="pf-name">
                Space Man
                <img src="icons/ship-wheel (1).svg" alt="Badge">
            </div>
            <span class="lvl">Level - 01</span>
            <span class="pf-email">spaceman@gmail.com</span>
            <!-- <button class="sign-out-btn">Sign out</button> -->
        </div>
    </div>
    <div id="overlay" class="overlay"></div>

    <div class="body-container">
        <h2 class="title">Card Collection</h2>
        <div class="back-arr" onclick="navigateBack()">
            <img class="back-arrow" src="icons/back-arrow.png" alt="back"> Back
        </div>
        <div class="card-container"></div>
    </div>
    <script src="scripts/profileScript.js"></script>
    <script src="/scripts/collection.js"></script>
    <script>
        // Function to flip cards
        function flipCard(card) {
            card.classList.toggle('is-flipped');
        }

// Function to navigate back
function navigateBack() {
    if (document.referrer) {
        window.history.back();
        
        // Wait until the page is loaded, then attach the event listeners
        window.addEventListener('load', function() {
            attachStarListeners(); // Attach listeners when back arrow is clicked
        });
    } else {
        window.location.href = "/card.html"; // Redirect to card page if no referrer
    }
}


        // Function to attach event listeners for removing cards
        function attachRemoveCardListeners() {
            document.querySelectorAll(".star").forEach(star => {
                star.addEventListener("click", function (event) {
                    event.stopPropagation(); // Prevent triggering flipCard()
                    const cardId = star.closest(".flashcard").getAttribute("data-card-id");
                    const userId = 1; // Placeholder user ID

                    fetch(`/collections/remove`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                        body: new URLSearchParams({ cardId, userId }),
                    })
                        .then(response => {
                            if (response.ok) {
                                console.log("Card removed successfully");
                                star.closest(".flashcard").remove(); // Remove card from DOM
                            } else {
                                return response.text().then(text => {
                                    console.error("Error removing card:", text);
                                });
                            }
                        })
                        .catch(error => console.error("Error removing card:", error));
                });
            });
        }

        // Function to load and display cards
        function loadCards() {
            const userId = 1; // Placeholder user ID
            fetch(`/collections?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const cardContainer = document.querySelector(".card-container");
                    cardContainer.innerHTML = ""; // Clear existing cards
                    data.forEach(card => {
                        cardContainer.innerHTML += 
                            `<div class="flashcard" data-card-id="${card.cardId}" onclick="flipCard(this)">
                                <div class="flashcard-face front">
                                    <div class="content-pic">
                                        <img class="pic" src="/images/4k-mercedes-red-zcj47yx9mq7tfjed.webp" alt="Image">
                                        <div class="star">
                                            <img class="star-icon" src="icons/icons8-star-50 (2).png" alt="star">
                                            <span class="tooltip">Remove Card</span>
                                        </div>
                                    </div>
                                    <div class="text-content">
                                        <h3>${card.keyword}</h3>
                                    </div>
                                </div>
                                <div class="flashcard-face back">
                                    <div class="text-content-back">
                                        <p>${card.definition}</p>
                                    </div>
                                </div>
                            </div>`;
                    });
                    attachRemoveCardListeners(); // Attach event listeners to the stars
                })
                .catch(error => console.error("Error fetching collections:", error));
        }

        // Load cards on DOMContentLoaded
        document.addEventListener("DOMContentLoaded", loadCards);

        window.onpopstate = function (event) {
    console.log("Back navigation detected");
    if (event.state === null) {
        console.log("This is a back navigation");
    } else {
        console.log("This is not a back navigation");
    }
    attachStarListeners(); // Re-attach star listeners when coming back
};

        //<img class="pic" src="/images/${card.image}" alt="image">
    </script>
</body>
</html>
